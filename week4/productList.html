<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>productList</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        img {
            object-fit: contain;
            max-width: 100%;
            }

        .primary-image {
            height: 300px;
        }

        .images {
            height: 150px;
        }
    </style>
</head>
<body>
    <div id="app">
      <div class="container">
        <div class="text-end mt-4">
          <button class="btn btn-primary"
            data-bs-toggle="modal" data-bs-target="#productModal"
            @click="openModal(true)">
            建立新的產品
          </button>
        </div>
        <table class="table mt-4">
          <thead>
            <tr>
              <th width="120">
                分類
              </th>
              <th>產品名稱</th>
              <th width="120">
                原價
              </th>
              <th width="120">
                售價
              </th>
              <th width="100">
                是否啟用
              </th>
              <th width="120">
                編輯
              </th>
            </tr>
          </thead>
          <tbody>
            <tr v-for=" product in products" :key="product.id">
              <td>{{product.category}}</td>
              <td>{{product.title}}</td>
              <td class="text-start">{{product.origin_price}}</td>
              <td class="text-start">{{product.price}}</td>
              <td>
                <div v-if="product.is_enabled === 1">
                  <p style="color: rgb(36, 212, 95);">啟用</p>
                </div>
                <div v-else>
                  <p style="color: red;">未啟用</p>
                </div>
              </td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-primary btn-sm" 
                    data-bs-toggle="modal" data-bs-target="#productModal"
                    v-on:click="openModal(false, product)">
                    編輯
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-sm" 
                    data-bs-toggle="modal" data-bs-target="#delProductModal" 
                    v-on:click="openModal(false, product)">
                    刪除
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- pagination -->
      <pagination :pages="pages" :get-products="getProducts" ></pagination>
      <!-- pagination -->


      <!-- Modal -->
      <!-- <div id="productModal" ref="productModal" class="modal fade" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content border-0">
            <div class="modal-header bg-dark text-white">
              <h5 id="productModalLabel" class="modal-title">
                <span v-if="tempProduct.title">{{tempProduct.title}}</span>
                <span v-else>新增產品</span>
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-sm-4">
                  <div class="mb-2">
                    <div class="mb-3">
                      <label for="imageUrl" class="form-label">輸入圖片網址</label>
                      <input id="addImageUrl" type="text" class="form-control" placeholder="請輸入圖片連結" 
                        ref="image" v-model="tempProduct.imageUrl">
                      <button type="button" class="btn btn-outline-primary btn-sm d-block w-100" @click="addImage()">
                        新增圖片
                      </button>
                    </div>

                    <template v-if="tempProduct.imagesUrl" v-for="(image, index) in tempProduct.imagesUrl" :key="image">
                      <img :src="image" v-bind:alt="tempProduct.title" class="card-img-top primary-image"
                        v-bind:title="`${tempProduct.title} : ${tempProduct.description}`">
                      <button type="button" class="btn btn-outline-danger btn-sm d-block w-100" @click="delImage(index)">
                        刪除圖片
                      </button>
                    </template>

                  </div>
                </div>
                <div class="col-sm-8">
                  <div class="mb-3">
                    <label for="title" class="form-label">標題</label>
                    <input id="title" type="text" class="form-control" 
                      placeholder="請輸入標題" v-model="tempProduct.title">
                  </div>

                  <div class="row">
                    <div class="mb-3 col-md-6">
                      <label for="category" class="form-label">分類</label>
                      <input id="category" type="text" class="form-control"
                             placeholder="請輸入分類" v-model="tempProduct.category">
                    </div>
                    <div class="mb-3 col-md-6">
                      <label for="unit" class="form-label">單位</label>
                      <input id="unit" type="text" class="form-control" 
                        placeholder="請輸入單位" v-model="tempProduct.unit">
                    </div>
                  </div>

                  <div class="row">
                    <div class="mb-3 col-md-6">
                      <label for="origin_price" class="form-label">原價</label>
                      <input id="origin_price" type="number" min="0" class="form-control" 
                        placeholder="請輸入原價" v-model.number="tempProduct.origin_price">
                    </div>
                    <div class="mb-3 col-md-6">
                      <label for="price" class="form-label">售價</label>
                      <input id="price" type="number" min="0" class="form-control"
                             placeholder="請輸入售價" v-model.number="tempProduct.price">
                    </div>
                  </div>
                  <hr>

                  <div class="mb-3">
                    <label for="description" class="form-label">產品描述</label>
                    <textarea id="description" type="text" class="form-control"
                      placeholder="請輸入產品描述" v-model="tempProduct.description">
                    </textarea>
                  </div>
                  <div class="mb-3">
                    <label for="content" class="form-label">說明內容</label>
                    <textarea id="content" type="text" class="form-control"
                      placeholder="請輸入說明內容" v-model="tempProduct.content">
                    </textarea>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input id="is_enabled" class="form-check-input" type="checkbox"
                        :true-value="1" :false-value="0"
                        v-model="tempProduct.is_enabled">
                      <label class="form-check-label" for="is_enabled">是否啟用</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                取消
              </button>
              <button type="button" class="btn btn-primary"
                @click="updataProduct(tempProduct)">
                確認送出
              </button>
            </div>
          </div>
        </div>
      </div> -->
      <Prod-Modal :temp-product="tempProduct" :updata-product="updataProduct" 
        :add-image="addImage" :del-image="delImage" ref="pModal"></Prod-Modal>

      <Del-Modal :temp-product="tempProduct" :del-product="delProduct" ref="dModal"></Del-Modal>
      <!-- Modal -->
    </div>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.9.1/axios.min.js'
            integrity='sha512-Xk3wWei2TGrsh9kDSBKUMIjw/86sLUvhtnv9f7fOuIwhhiUTKz8szkWkzHthrM5Bb3Bu9idSzkxOrkzhcneuiw=='
            crossorigin='anonymous'></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"
            integrity="sha384-SR1sx49pcuLnqZUnnPwx6FCym0wLsk5JZuNx2bPPENzswTNFaQU1RDvt3wT4gWFG"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.min.js"
            integrity="sha384-j0CNLUeiqtyaRmlzUHCPZ+Gy5fQu0dQ6eZ/xAww941Ai1SxSY+0EQqNXNE6DZiVc"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    
    <script type="module">
      const { createApp } = Vue;

      // const card2 = {
      //   data() {
      //   },
      //   template:``
      // };

      import pagination from './components/pagination.js';
      import ProdModal from './components/productModal.js'
      import DelModal from './components/delProductModal.js';
      


      const app = createApp({
        data(){
          return {
            apiUrl: 'https://vue3-course-api.hexschool.io/v2',
            apiPath: 'jeff_hexschool',
            isNew: false,
            tempProduct: {}, //點選產品
            selectID: '', //點選產品ID
            products : [], //產品菜單
            pages: {}, //產品菜單-頁碼

            //productModal: null, 
            //delModal: null,
          }
        },
        methods: {
          checkSignIn() {
            const api = `${this.apiUrl}/api/user/check`;
            axios.post(api)
            .then((res) => {
                this.getProducts();
            })
            .catch((err) => {
                alert('請重新登入，將轉回登入頁面');
                window.location.assign("login.html");
            })
          },
          getProducts(page = 1) {
            const api = `${this.apiUrl}/api/${this.apiPath}/admin/products?page=${page}`;
            axios.get(api)
            .then((res) => {
              this.products = res.data.products;
              this.pages = res.data.pagination;
            })
          },
          openModal(isNew, item) {
            if (isNew) {
              this.tempProduct = {}
            } 
            else {
              this.tempProduct = { ...item }
            }
            this.isNew = isNew
          },
          updataProduct(item) {
            let api = `${this.apiUrl}/api/${this.apiPath}/admin/product`; //預設新增，再來判斷isNew
            let httpMethod = 'post'
            if (!this.isNew) {
              api = `${this.apiUrl}/api/${this.apiPath}/admin/product/${item.id}`
              httpMethod = 'put'
            }
            axios[httpMethod](api, { data: item })
            .then((res) => {
              this.isNew = false;
              this.getProducts();
              //this.productModal.hide(); 
              this.$refs.pModal.closeModal(); 
            })
            .catch((err) => {
              alert(err.data.message);
            })
          },
          delProduct(itemID) {
            let api = `${this.apiUrl}/api/${this.apiPath}/admin/product/${itemID}`; //預設新增，再來判斷isNew
            let httpMethod = 'delete';
            axios[httpMethod](api)
            .then((res) => {
              this.getProducts();
              //this.delModal.hide();
              this.$refs.dModal.closeModal();
            })
            .catch((err) => {
              alert(err.data.message);
            })
          },
          addImage() {
            if (this.tempProduct.imagesUrl === undefined){
              this.tempProduct.imagesUrl = [];
            }
            const addImageUrl = document.getElementById('addImageUrl').value;
            this.tempProduct.imagesUrl.push(addImageUrl);
          },
          delImage(index) {
            this.tempProduct.imagesUrl.splice(index, 1);
          },
          // clearData() {
          //   this.tempProduct = {}; 
          //   this.isNew = false;
          // },

          
        },
        created(){
          const token = document.cookie.replace(
            /(?:(?:^|.*;\s*)shopToken\s*\=\s*([^;]*).*$)|^.*$/,
            "$1"
          );
          axios.defaults.headers.common["Authorization"] = token;
          this.checkSignIn();
        },
        mounted() {
          //this.productModal = new bootstrap.Modal(this.$refs.productModal);
          //this.delModal = new bootstrap.Modal(this.$refs.delProductModal);
        },
        components: {
          pagination,
          ProdModal,
          DelModal
        }
      });



      // app.component('card', {
      //   data() {

      //   },
      //   template:``
      // });

      app.mount('#app');
    </script>

  </body>
</html>